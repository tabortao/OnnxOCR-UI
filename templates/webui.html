<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>OnnxOCR Web UI</title>
    <link rel="stylesheet" href="/static/webui.css">
</head>
<body>
<div class="container">
    <h2>OnnxOCR Web UI</h2>
    <form id="ocrForm">
        <div class="form-row">
            <label for="modelSelect">选择模型：</label>
            <select id="modelSelect" name="model_name">
                <option value="PP-OCRv5">PP-OCRv5</option>
                <option value="PP-OCRv4">PP-OCRv4</option>
                <option value="ch_ppocr_server_v2.0">ch_ppocr_server_v2.0</option>
            </select>
            <button type="button" id="clearBtn">清除</button>
        </div>
        <div class="form-row">
            <div id="dropZone" class="drop-zone">点击或拖拽图片/PDF文件到此处（可多选）</div>
            <input id="fileInput" type="file" name="files" multiple accept="image/*,.pdf" />
        </div>
        <div class="form-row">
            <ul id="fileList"></ul>
        </div>
        <div class="form-row button-row">
            <button type="submit">开始识别</button>
        </div>
    </form>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;">
        <button id="downloadBtn">下载全部TXT（压缩包）</button>
    </div>
    <div id="loading">正在识别，请稍候...</div>
    <div id="resultArea"></div>
</div>
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const ocrForm = document.getElementById('ocrForm');
const resultArea = document.getElementById('resultArea');
const downloadBtn = document.getElementById('downloadBtn');
const loading = document.getElementById('loading');
const fileList = document.getElementById('fileList');
const clearBtn = document.getElementById('clearBtn');
let lastZipUrl = null;

function updateFileList() {
    fileList.innerHTML = '';
    if (fileInput.files.length === 0) {
        fileList.innerHTML = '<li style="color:#888;">未选择文件</li>';
        return;
    }
    for (const file of fileInput.files) {
        const li = document.createElement('li');
        li.textContent = file.name;
        fileList.appendChild(li);
    }
}

// 拖拽上传
['dragenter','dragover'].forEach(evt => dropZone.addEventListener(evt, e => {
    e.preventDefault();
    dropZone.classList.add('dragover');
}));
['dragleave','drop'].forEach(evt => dropZone.addEventListener(evt, e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
}));
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('drop', e => {
    fileInput.files = e.dataTransfer.files;
    updateFileList();
});
fileInput.addEventListener('change', updateFileList);

ocrForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!fileInput.files.length) {
        alert('请先选择图片或PDF文件');
        return;
    }
    loading.style.display = 'block';
    resultArea.innerHTML = '';
    downloadBtn.style.display = 'none';
    fileList.innerHTML = '';
    const formData = new FormData();
    for (const file of fileInput.files) {
        formData.append('files', file);
    }
    formData.append('model_name', document.getElementById('modelSelect').value);
    try {
        const resp = await fetch('/ocr', { method: 'POST', body: formData });
        const data = await resp.json();
        loading.style.display = 'none';
        if (!data.success) {
            resultArea.innerHTML = `<div style='color:red;'>识别失败：${data.msg || ''}</div>`;
            return;
        }
        lastZipUrl = data.zip_url;
        // 新增：构建文件名到File对象的映射
        const fileMap = {};
        for (const file of fileInput.files) {
            fileMap[file.name] = file;
        }
        data.results.forEach(r => {
            const div = document.createElement('div');
            div.className = 'result-block';
            // 判断是否为图片文件
            const ext = r.filename.split('.').pop().toLowerCase();
            const isImage = ['jpg','jpeg','png','bmp','gif','webp'].includes(ext);
            let imgHtml = '';
            if (isImage && fileMap[r.filename.replace(/\.txt$/, '') + '.' + ext]) {
                // 兼容 txt 文件名和原图名一致的情况
                const imgFile = fileMap[r.filename.replace(/\.txt$/, '') + '.' + ext] || fileMap[r.filename.replace(/\.txt$/, '')];
                if (imgFile) {
                    const url = URL.createObjectURL(imgFile);
                    imgHtml = `<img class="ocr-image-preview" src="${url}" alt="${r.filename}">`;
                }
            }
            div.innerHTML = `${imgHtml ? imgHtml : ''}<div class="ocr-text-content"><b>${r.filename}</b><pre>${r.content}</pre></div>`;
            resultArea.appendChild(div);
        });
        downloadBtn.style.display = 'inline-block';
    } catch (err) {
        loading.style.display = 'none';
        resultArea.innerHTML = `<div style='color:red;'>请求失败：${err}</div>`;
    }
});

downloadBtn.addEventListener('click', function() {
    if (lastZipUrl) {
        window.open(lastZipUrl, '_blank');
    }
});

clearBtn.addEventListener('click', function() {
    fileInput.value = '';
    updateFileList();
    resultArea.innerHTML = '';
    downloadBtn.style.display = 'none';
});
</script>
</body>
</html>
